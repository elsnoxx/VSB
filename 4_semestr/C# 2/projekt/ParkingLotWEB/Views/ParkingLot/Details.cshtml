@model ParkingLotWEB.Models.ViewModels.ParkingLotDetailsViewModel

@{
    ViewData["Title"] = "Detail parkoviště";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
    #map {
        width: 100%;
        height: 350px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    .info-card {
        background: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
</style>

<h2 class="mb-4">Detail parkoviště</h2>
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="row">
            <div class="col-md-6">
                <div class="info-card">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Název</dt>
                        <dd class="col-sm-7">@Model.Name</dd>
                        <dt class="col-sm-5">Latitude</dt>
                        <dd class="col-sm-7">@Model.Latitude</dd>
                        <dt class="col-sm-5">Longitude</dt>
                        <dd class="col-sm-7">@Model.Longitude</dd>
                        <dt class="col-sm-5">Počet parkovacích míst</dt>
                        <dd class="col-sm-7">@Model.Capacity</dd>
                    </dl>
                </div>
            </div>
            <div class="col-md-6">
                <div id="map"></div>
            </div>
        </div>

        <h4 class="mt-4">Vaše zaparkovaná auta</h4>
        <div class="d-flex flex-wrap gap-2" id="userFunctions">
            @foreach (var space in Model.ParkingSpaces.Where(s => s.Status == "occupied" && s.OwnerId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value))
            {
                <div class="space-item" data-space="@space.SpaceNumber" style="display:inline-block;text-align:center;">
                    <svg width="32" height="32">
                        <circle cx="16" cy="16" r="12" fill="red" stroke="black" stroke-width="2"/>
                    </svg>
                    <div>@space.SpaceNumber</div>
                    <button class="btn btn-sm btn-danger mt-1" onclick="releaseCar(@space.ParkingSpaceId)">Odjet</button>
                </div>
            }
        </div>

        <h4 class="mt-4">Zaparkovat auto</h4>
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form id="parkForm">
                    <div class="mb-3">
                        <label for="parkingSpaceSelect" class="form-label">Vyberte volné parkovací místo</label>
                        <select id="parkingSpaceSelect" class="form-select" required>
                            <option value="" disabled selected>Vyberte místo...</option>
                            @foreach (var space in Model.ParkingSpacesWithDetails.Where(s => s.Status == "available"))
                            {
                                <option value="@space.ParkingSpaceId">Místo @space.SpaceNumber</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="userCarSelect" class="form-label">Vyberte auto</label>
                        <select id="userCarSelect" class="form-select" required>
                            <option value="" disabled selected>Vyberte auto...</option>
                            @foreach (var car in Model.UserCars)
                            {
                                <option value="@car.LicensePlate">@car.LicensePlate - @car.BrandModel</option>
                            }
                        </select>
                    </div>
                    <button type="button" class="btn btn-success" onclick="parkCar()">Zaparkovat</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            try {
                var lat = parseFloat('@Model.Latitude'.replace(',', '.'));
                var lng = parseFloat('@Model.Longitude'.replace(',', '.'));
                var map = L.map('map').setView([lat, lng], 16);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                L.marker([lat, lng]).addTo(map)
                    .bindPopup('@Model.Name')
                    .openPopup();
            } catch (e) {
                console.error("Chyba při inicializaci mapy:", e);
            }
        });

        async function releaseCar(parkingSpaceId) {
            if (!confirm("Opravdu chcete toto místo uvolnit?")) return;
            const response = await fetch(`/api/ParkingSpaceApi/release/${parkingSpaceId}`, { method: "POST" });
            if (response.ok) {
                location.reload();
            } else {
                alert("Nepodařilo se uvolnit místo.");
            }
        }

        async function parkCar() {
            const parkingSpaceId = document.getElementById('parkingSpaceSelect').value;
            const licensePlate = document.getElementById('userCarSelect').value;

            if (!parkingSpaceId || !licensePlate) {
                alert("Vyberte parkovací místo a auto.");
                return;
            }

            const response = await fetch(`/api/ParkingSpaceApi/occupy/${parkingSpaceId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ licensePlate })
            });

            if (response.ok) {
                location.reload();
            } else {
                alert("Nepodařilo se zaparkovat auto.");
            }
        }
    </script>
}

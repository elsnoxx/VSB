@model ParkingLotWEB.Models.ViewModels.ParkingLotDetailsViewModel

@{
    ViewData["Title"] = "Detail parkoviště";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
    #map {
        width: 100%;
        height: 350px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    .info-card {
        background: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
</style>

<h2 class="mb-4">Detail parkoviště</h2>
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="row">
            <div class="col-md-6">
                <div class="info-card">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Název</dt>
                        <dd class="col-sm-7">@Model.Name</dd>
                        <dt class="col-sm-5">Latitude</dt>
                        <dd class="col-sm-7">@Model.Latitude</dd>
                        <dt class="col-sm-5">Longitude</dt>
                        <dd class="col-sm-7">@Model.Longitude</dd>
                        <dt class="col-sm-5">Počet parkovacích míst</dt>
                        <dd class="col-sm-7">@Model.FreeSpaces/@Model.Capacity</dd>
                        <dt class="col-sm-5">Cena za hodinu</dt>
                        <dd class="col-sm-7">@Model.PricePerHour Kč</dd>
                    </dl>
                </div>
            </div>
            <div class="col-md-6">
                <div id="map"></div>
            </div>
        </div>

        <h4 class="mt-4">Vaše zaparkovaná auta</h4>
        <div class="d-flex flex-wrap gap-2" id="userFunctions">
            @{
                var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                var userSpaces = Model.ParkingSpaces.Where(s => s.Status == "occupied" && s.OwnerId == userId).ToList();
                var hasCars = Model.UserCars.Any();
            }
            @if (userSpaces.Any())
            {
                foreach (var space in userSpaces)
                {
                    <div class="space-item" data-space="@space.SpaceNumber" style="display:inline-block;text-align:center;">
                        <svg width="32" height="32">
                            <circle cx="16" cy="16" r="12" fill="red" stroke="black" stroke-width="2"/>
                        </svg>
                        <div>@space.SpaceNumber</div>
                        <form asp-action="ReleaseCar" asp-controller="ParkingLot" method="post" style="display:inline;">
                            <input type="hidden" name="ParkingSpaceId" value="@space.ParkingSpaceId" />
                            <input type="hidden" name="ParkingLotId" value="@Model.ParkingLotId" />
                            <button type="submit" class="btn btn-sm btn-danger mt-1">Odjet</button>
                        </form>
                    </div>
                }
            }
            else
            {
                if (hasCars)
                {
                    <div>
                        Nemáte zde žádné zaparkované auto. <a asp-controller="User" asp-action="Profil">Přejít na profil</a>
                    </div>
                }
                else
                {
                    <div>
                        Nemáte registrované žádné auto. <a asp-controller="User" asp-action="Profil">Zaregistrovat auto v profilu</a>
                    </div>
                }
            }
        </div>

        <h4 class="mt-4">Zaparkovat auto</h4>
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                @{
                    var availableCars = Model.UserCars.Where(car => !Model.OccupiedLicensePlates.Contains(car.LicensePlate)).ToList();
                }
                @if (availableCars.Any())
                {
                    foreach (var car in availableCars)
                    {
                        <form asp-action="ParkCar" asp-controller="ParkingLot" method="post" style="display:inline;">
                            <input type="hidden" name="ParkingLotId" value="@Model.ParkingLotId" />
                            <input type="hidden" name="LicensePlate" value="@car.LicensePlate" />
                            <button type="submit" class="btn btn-success mb-2">
                                Zaparkovat @car.LicensePlate - @car.BrandModel
                            </button>
                        </form>
                    }
                }
                else
                {
                    <div>
                        Nemáte žádné volné auto k zaparkování.
                        <a asp-controller="User" asp-action="Profil">Zaregistrovat auto v profilu</a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            try {
                var lat = parseFloat('@Model.Latitude'.replace(',', '.'));
                var lng = parseFloat('@Model.Longitude'.replace(',', '.'));
                var map = L.map('map').setView([lat, lng], 16);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                L.marker([lat, lng]).addTo(map)
                    .bindPopup('@Model.Name')
                    .openPopup();
            } catch (e) {
                console.error("Chyba při inicializaci mapy:", e);
            }
        });

    </script>
}

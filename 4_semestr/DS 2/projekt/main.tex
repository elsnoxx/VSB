\documentclass[10pt,a4paper]{article}
\usepackage[left=20mm,right=30mm,top=30mm,bottom=35mm]{geometry} 

\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
    pdftitle={Projekt DS II - Hotel},
    pdfpagemode=FullScreen,
}

\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\rhead{Projekt DS II - Hotel}
\lfoot{Richard Ficek, FIC0024}
\rfoot{\thepage}

\title{Projekt DS II - Hotel}
\author{Richard Ficek, FIC0024}
\date{\today}

\begin{document}
\maketitle

\newpage

\tableofcontents

\newpage

\section{Datová analýza}
\begin{figure}[ht]  
    \centering
    \includegraphics[width=1\textwidth]{schema.png}
    \caption{Konceptuální datový model}
    \label{fig:obrazek}
\end{figure}

\newpage

\section{Lineární zápis}
Legenda: \textbf{Tabulka}, \underline{primární klíč}, \textit{cizí klíč}, atribut

\begin{itemize} 
\item \textbf{Address} – Jeden záznam v této tabulce reprezentuje jedinečnou adresu, včetně ulice, města, PSČ a země, kterou mohou sdílet hosté nebo zaměstnanci hotelu. 
\item \textbf{Guest} – Jeden záznam v této tabulce reprezentuje jednotlivého hosta hotelu se základními informacemi jako jméno, příjmení, kontakt, datum narození, typ hosta (např. pravidelný, VIP) a datum registrace. 
\item \textbf{Employee} – Jeden záznam v této tabulce reprezentuje konkrétního zaměstnance hotelu, včetně jeho identifikátoru, pozice a adresy. 
\item \textbf{RoomType} – Jeden záznam v této tabulce reprezentuje typ pokoje (např. jednolůžkový, dvoulůžkový), včetně počtu postelí a ceny za noc. 
\item \textbf{Room} – Jeden záznam v této tabulce reprezentuje jednotlivý pokoj v hotelu s konkrétním číslem, typem pokoje, obsazeností a unikátním identifikátorem. 
\item \textbf{Payment} – Jeden záznam v této tabulce reprezentuje platbu provedenou hostem, včetně částky za ubytování, celkových výdajů, data platby a informace, zda byla platba provedena. 
\item \textbf{Reservation} – Jeden záznam v této tabulce reprezentuje rezervaci vytvořenou hostem, včetně identifikátoru hosta, přiděleného pokoje, zodpovědného zaměstnance, datumu vytvoření, datumu příjezdu a odjezdu, platby a stavu rezervace (např. potvrzeno, zrušeno). 
\item \textbf{Service} – Jeden záznam v této tabulce reprezentuje službu nebo doplňkový produkt nabízený hotelem, včetně názvu, popisu a ceny.
\item \textbf{ServiceUsage} – Jeden záznam v této tabulce reprezentuje využití konkrétní služby hostem během jeho pobytu v rámci určité rezervace, včetně množství a celkové ceny.
\item \textbf{Feedback} – Jeden záznam v této tabulce reprezentuje hodnocení a komentář od hosta k jeho pobytu v hotelu, včetně číselného hodnocení, textového komentáře a data poskytnutí zpětné vazby.
\end{itemize}

\begin{table}
\caption{Atributy tabulky Address}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    address\_id           & int                & -              & P             & N              & A               & -              & ID adresy          \\ \hline  
    street                & varchar            & 255            & -             & N              & -               & -              & Ulice              \\ \hline  
    city                  & varchar            & 100            & -             & N              & -               & -              & Město              \\ \hline  
    postal\_code          & char               & 10             & -             & N              & -               & -              & PSČ                \\ 
    country               & varchar            & 100            & -             & N              & -               & -              & Země               \\ 
     \hline
\end{tabular}  
\label{tab:address}

\caption{Atributy tabulky Guest}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    guest\_id             & int                & -              & P             & N              & A               & -              & ID hosta           \\ \hline  
    firstname             & varchar            & 50             & -             & N              & -               & -              & Jméno hosta        \\ \hline  
    lastname              & varchar            & 50             & -             & N              & -               & -              & Příjmení hosta     \\ \hline  
    email                 & varchar            & 100            & -             & N              & -               & -              & Email hosta        \\ \hline  
    phone                 & varchar            & 15             & -             & A              & -               & -              & Telefon hosta      \\ \hline  
    birth\_date           & date               & -              & -             & N              & -               & -              & Datum narození     \\ \hline  
    address\_id           & int                & -              & F(Address)    & N              & -               & -              & ID adresy          \\ \hline  
    guest\_type           & varchar            & 50             & -             & N              & -               & -              & Typ hosta          \\ \hline  
    registration\_date    & date               & -              & -             & N              & -               & -              & Datum registrace    \\ 
    notes                 & text               & -              & -             & A              & -               & -              & Poznámky hosta     \\ 
     \hline
\end{tabular}  
\label{tab:guest}

\caption{Atributy tabulky Employee}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    employee\_id          & int                & -              & P             & N              & A               & -              & ID zaměstnance     \\ \hline  
    firstname             & varchar            & 50             & -             & N              & -               & -              & Jméno zaměstnance   \\ \hline  
    lastname              & varchar            & 50             & -             & N              & -               & -              & Příjmení zaměstnance\\ \hline  
    position              & varchar            & 100            & -             & N              & -               & -              & Pozice zaměstnance  \\ 
    address\_id           & int                & -              & F(Address)    & N              & -               & -              & ID adresy          \\ 
     \hline
\end{tabular}  
\label{tab:employee}

\caption{Atributy tabulky RoomType}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    room\_type\_id       & int                & -              & P             & N              & A               & -              & ID typu pokoje     \\ \hline  
    name                  & varchar            & 100            & -             & N              & -               & -              & Název typu pokoje   \\ \hline  
    bed\_count            & int                & -              & -             & N              & -               & -              & Počet postelí      \\ 
    price\_per\_night     & decimal            & -              & -             & N              & -               & -              & Cena za noc        \\ 
     \hline
\end{tabular}  
\label{tab:roomtype}

\caption{Atributy tabulky Room}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    room\_id             & int                & -              & P             & N              & A               & -              & ID pokoje          \\ \hline  
    room\_type\_id       & int                & -              & F(RoomType)   & N              & -               & -              & ID typu pokoje     \\ \hline  
    room\_number          & varchar            & 10             & -             & N              & -               & -              & Číslo pokoje       \\ 
    is\_occupied          & boolean            & -              & -             & N              & -               & -              & Obsazenost pokoje  \\ 
     \hline
\end{tabular}  
\label{tab:room}
\end{table}

\begin{table}
\caption{Atributy tabulky Payment}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    payment\_id          & int                & -              & P             & N              & A               & -              & ID platby          \\ \hline  
    total\_accommodation   & decimal            & -              & -             & N              & -               & -              & Celkové náklady na ubytování \\ \hline  
    total\_expenses       & decimal            & -              & -             & N              & -               & -              & Celkové výdaje     \\ \hline  
    payment\_date        & date               & -              & -             & N              & -               & -              & Datum platby       \\ 
    is\_paid             & boolean            & -              & -             & N              & -               & -              & Stav platby        \\ 
     \hline
\end{tabular}  
\label{tab:payment}

\caption{Atributy tabulky Reservation}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    reservation\_id      & int                & -              & P             & N              & A               & -              & ID rezervace       \\ \hline  
    guest\_id             & int                & -              & F(Guest)      & N              & -               & -              & ID hosta           \\ \hline  
    room\_id              & int                & -              & F(Room)       & N              & -               & -              & ID pokoje          \\ \hline  
    employee\_id          & int                & -              & F(Employee)   & N              & -               & -              & ID zaměstnance     \\ \hline  
    creation\_date        & date               & -              & -             & N              & -               & -              & Datum vytvoření    \\ \hline  
    check\_in\_date      & date               & -              & -             & N              & -               & -              & Datum příjezdu     \\ \hline  
    check\_out\_date     & date               & -              & -             & N              & -               & -              & Datum odjezdu      \\ \hline  
    payment\_id          & int                & -              & F(Payment)    & N              & -               & -              & ID platby          \\ 
    status                & varchar            & 20             & -             & N              & -               & -              & Stav rezervace     \\ 
     \hline
\end{tabular}  
\label{tab:reservation}

\caption{Atributy tabulky Service}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    service\_id          & int                & -              & P             & N              & A               & -              & ID služby          \\ \hline  
    name                & varchar            & 100            & -             & N              & -               & -              & Název služby       \\ \hline  
    description         & text               & -              & -             & A              & -               & -              & Popis služby       \\ \hline  
    price               & decimal            & -              & -             & N              & -               & -              & Cena služby        \\ 
     \hline
\end{tabular}  
\label{tab:service}

\caption{Atributy tabulky ServiceUsage}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    usage\_id            & int                & -              & P             & N              & A               & -              & ID využití služby  \\ \hline  
    reservation\_id      & int                & -              & F(Reservation) & N              & -               & -              & ID rezervace       \\ \hline  
    service\_id          & int                & -              & F(Service)    & N              & -               & -              & ID služby          \\ \hline  
    quantity             & int                & -              & -             & N              & -               & -              & Množství           \\ \hline
    usage\_date          & date               & -              & -             & N              & -               & -              & Datum využití      \\ \hline  
    total\_price         & decimal            & -              & -             & N              & -               & -              & Celková cena       \\ 
     \hline
\end{tabular}  
\label{tab:serviceusage}

\caption{Atributy tabulky Feedback}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    feedback\_id         & int                & -              & P             & N              & A               & -              & ID zpětné vazby    \\ \hline  
    guest\_id            & int                & -              & F(Guest)      & N              & -               & -              & ID hosta           \\ \hline  
    reservation\_id      & int                & -              & F(Reservation) & N              & -               & -              & ID rezervace       \\ \hline  
    rating               & int                & -              & -             & N              & -               & -              & Hodnocení (1-5)    \\ \hline  
    comment              & text               & -              & -             & A              & -               & -              & Komentář           \\ \hline  
    feedback\_date       & date               & -              & -             & N              & -               & -              & Datum hodnocení    \\ 
     \hline
\end{tabular}  
\label{tab:feedback}
\end{table}

\newpage

\section{Integritní omezení}

\begin{itemize}
    \item \textbf{check\_in\_date} \< \textbf{check\_out\_date} – Datum příjezdu musí být dříve než datum odjezdu.
    \item \textbf{guest\_type} – Může nabývat hodnot \{Regular, VIP, Loyalty\}.
    \item \textbf{status} – Může nabývat hodnot \{Confirmed, Checked In, Checked Out, Cancelled\}.
    \item \textbf{address\_id} – Odkazuje na existující záznam v tabulce \textbf{Address}.
    \item \textbf{room\_type\_id} – Odkazuje na existující záznam v tabulce \textbf{RoomType}.
    \item \textbf{payment\_id} – Odkazuje na existující záznam v tabulce \textbf{Payment}.
    \item \textbf{is\_paid} – Může nabývat hodnot \{0 (neuhrazeno), 1 (uhrazeno)\}.
    \item \textbf{room\_number} – Musí být unikátní v rámci tabulky \textbf{Room}.
    \item \textbf{rating} – Může nabývat hodnot od 1 do 5, představujících hodnocení spokojenosti hosta.
    \item \textbf{quantity} – Musí být větší než 0, určuje počet využitých jednotek služby.
    \item \textbf{service\_id} – Odkazuje na existující záznam v tabulce \textbf{Service}.
    \item \textbf{reservation\_id} v \textbf{ServiceUsage} a \textbf{Feedback} – Odkazuje na existující záznam v tabulce \textbf{Reservation}.
    \item \textbf{price} v \textbf{Service} – Musí být nezáporná hodnota.
    \item \textbf{total\_price} v \textbf{ServiceUsage} – Musí být nezáporná hodnota.
    \item \textbf{email} – Musí obsahovat znak @ a platnou doménu.
    \item \textbf{total\_accommodation} a \textbf{total\_expenses} – Musí být nezáporné hodnoty.
\end{itemize}

\newpage
\section{Návrh formuláře}

V této části popisuji návrh formuláře pro správu hotelových rezervací, který pracuje s více tabulkami a jejich vztahy. Formulář je navržen jako praktický nástroj pro každodenní správu rezervací, hostů, pokojů a služeb.

\subsection{Popis formuláře}
Formulář „Správa hotelových rezervací" je centrálním bodem pro práci s rezervacemi v hotelovém systému. Umožňuje vyhledávání, zobrazení detailů a správu rezervací včetně přidružených entit. Formulář pracuje s následujícími tabulkami:

\begin{itemize}
    \item \textbf{Reservation} - základní entita rezervace
    \item \textbf{Guest} - informace o hostovi
    \item \textbf{Room} - informace o pokoji
    \item \textbf{RoomType} - informace o typu pokoje
    \item \textbf{Payment} - informace o platbě spojené s rezervací
    \item \textbf{Service} - informace o dostupných službách
    \item \textbf{ServiceUsage} - využití služeb v rámci rezervace
\end{itemize}

\subsection{Rozložení formuláře}
Formulář je rozdělen do několika logických částí:
\begin{itemize}
    \item \textbf{Hlavička} - název aplikace a základní ovládací prvky
    \item \textbf{Vyhledávací část} - pole pro filtrování rezervací podle data příjezdu
    \item \textbf{Přehledová tabulka} - tabulkový výpis rezervací s klíčovými informacemi
    \item \textbf{Detail rezervace} - detailní informace o vybrané rezervaci
    \item \textbf{Informace o hostovi} - kontaktní a osobní údaje hosta
    \item \textbf{Informace o pokoji} - detaily přiřazeného pokoje
    \item \textbf{Platby a služby} - přehled cen a využitých služeb
\end{itemize}

\newpage

\subsection{Seznam implementovaných funkcí}
Formulář Správa hotelových rezervací poskytuje následujících 10 funkcí, které jsou rozděleny na dvě kategorie podle způsobu volání:

\subsubsection{Funkce typu Result (výsledkové)}
Tyto funkce zobrazují data bez aktivní změny databáze:

\begin{enumerate}
    \item \textbf{getReservation} - Zobrazení seznamu všech rezervací v přehledové tabulce. Funkce načítá data ze všech relevantních tabulek a zobrazuje klíčové informace jako ID rezervace, jméno hosta, číslo pokoje, datum příjezdu a status rezervace.
    
    \item \textbf{getGuestInformation} - Zobrazení detailních informací o hostovi včetně kontaktních údajů a adresy. Po výběru rezervace ze seznamu se automaticky načtou a zobrazí veškeré dostupné informace o hostovi z tabulky Guest.
    
    \item \textbf{getRoomType} - Zobrazení informací o typu pokoje včetně počtu lůžek a standardní ceny. Funkce získává data z tabulky RoomType pro vybraný pokoj a zobrazuje je v detailu rezervace.
    
    \item \textbf{getPriceOfAccommodation} - Výpočet a zobrazení ceny za ubytování na základě typu pokoje a délky pobytu. Funkce počítá cenu jako násobek počtu nocí a ceny za noc pro daný typ pokoje.
    
    \item \textbf{getUsageService} - Zobrazení seznamu služeb využitých v rámci dané rezervace včetně množství a ceny. V sekci plateb je tabulka s přehledem všech služeb načtených z tabulky ServiceUsage.
\end{enumerate}

\subsubsection{Funkce typu Invocation (vyvolávací)}
Tyto funkce aktivně mění data v databázi:

\begin{enumerate}\setcounter{enumi}{5}
    \item \textbf{getReservationByCheckin} - Filtrování seznamu rezervací podle data příjezdu. Uživatel zadá požadované datum do pole ve vyhledávací části a systém zobrazí pouze rezervace s odpovídajícím datem příjezdu.
    
    \item \textbf{changeStatusReservation} - Změna statusu rezervace (Confirmed, Checked-In, Checked-Out, Cancelled). Pomocí rozbalovacího seznamu v detailu rezervace lze změnit stav rezervace, což automaticky aktualizuje databázi a může spustit související procesy (např. označení pokoje jako obsazeného).
    
    \item \textbf{changeRoom} - Změna přiřazeného pokoje pro existující rezervaci. Pomocí formulářového pole v detailu rezervace lze změnit číslo pokoje, přičemž systém automaticky ověří dostupnost nového pokoje v daném termínu.
    
    \item \textbf{payForReservation} - Označení rezervace jako zaplacené. Pomocí tlačítka Pay v sekci plateb lze označit platbu jako dokončenou, což aktualizuje pole ispaid v tabulce Payment.
    
    \item \textbf{addService} - Přidání nové služby k vybrané rezervaci. Pomocí tlačítka "Add" lze přidat novou službu z katalogu, zadat množství a systém automaticky vypočítá celkovou cenu a přidá záznam do tabulky ServiceUsage.
\end{enumerate}

\newpage

\subsection{Integrace s databází}

Formulář využívá následující SQL dotazy pro implementaci klíčových funkcí:

\begin{itemize}
    \item \textbf{getReservation - Získání všech rezervací:}
    
    \begin{verbatim}
SELECT r.reservation_id, g.firstname, g.lastname, rm.room_number, 
       r.check_in_date, r.status
FROM Reservation r
JOIN Guest g ON r.guest_id = g.guest_id
JOIN Room rm ON r.room_id = rm.room_id
ORDER BY r.check_in_date;
    \end{verbatim}
    
    \item \textbf{getReservationByCheckin - Filtrování podle data příjezdu:}
    
    \begin{verbatim}
SELECT r.reservation_id, g.firstname, g.lastname, rm.room_number, 
       r.check_in_date, r.status
FROM Reservation r
JOIN Guest g ON r.guest_id = g.guest_id
JOIN Room rm ON r.room_id = rm.room_id
WHERE r.check_in_date = TO_DATE(:selected_date, 'DD.MM.YYYY')
ORDER BY r.reservation_id;
    \end{verbatim}
    
    \item \textbf{changeStatusReservation - Změna statusu rezervace:}
    
    \begin{verbatim}
UPDATE Reservation
SET status = :new_status
WHERE reservation_id = :selected_reservation_id;
    \end{verbatim}
    
    \item \textbf{getPriceOfAccommodation - Výpočet ceny ubytování:}
    
    \begin{verbatim}
SELECT 
    rt.price_per_night,
    (r.check_out_date - r.check_in_date) AS nights,
    rt.price_per_night * (r.check_out_date - r.check_in_date) AS total_price
FROM Reservation r
JOIN Room rm ON r.room_id = rm.room_id
JOIN RoomType rt ON rm.room_type_id = rt.room_type_id
WHERE r.reservation_id = :selected_reservation_id;
    \end{verbatim}
    
    \item \textbf{addService - Přidání služby k rezervaci:}
    
    \begin{verbatim}
INSERT INTO ServiceUsage (reservation_id, service_id, quantity, usage_date, total_price)
VALUES (:reservation_id, :service_id, :quantity, SYSDATE, 
        :quantity * (SELECT price FROM Service WHERE service_id = :service_id));
    \end{verbatim}

\newpage
    
    \item \textbf{changeRoom - Změna pokoje pro rezervaci:}
    
    \begin{verbatim}
-- Nejprve kontrola dostupnosti nového pokoje
SELECT COUNT(*) 
FROM Reservation res
WHERE res.room_id = :new_room_id
  AND res.reservation_id != :current_reservation_id
  AND res.status != 'Cancelled'
  AND (
      (:check_in_date BETWEEN res.check_in_date AND res.check_out_date)
      OR (:check_out_date BETWEEN res.check_in_date AND res.check_out_date)
      OR (res.check_in_date BETWEEN :check_in_date AND :check_out_date)
  );
  
-- Pokud je pokoj dostupný, provedeme změnu
UPDATE Reservation
SET room_id = :new_room_id
WHERE reservation_id = :current_reservation_id;
    \end{verbatim}
    
    \item \textbf{payForReservation - Označení platby jako dokončené:}
    
    \begin{verbatim}
UPDATE Payment
SET is_paid = 1,
    payment_date = SYSDATE
WHERE payment_id = (SELECT payment_id FROM Reservation WHERE reservation_id = :reservation_id);
    \end{verbatim}
\end{itemize}

\subsection{Uživatelské rozhraní}

Formulář je navržen s důrazem na přehlednost a efektivitu práce. Grafické rozhraní obsahuje:

\begin{itemize}
    \item Modrou hlavičku s názvem aplikace pro jasnou identifikaci
    \item Tabulkový přehled rezervací s barevným odlišením různých stavů
    \item Oddíly pro detailní informace o rezervaci, hostovi a pokoji
    \item Přehledný systém pro správu plateb a služeb
    \item Tlačítka pro rychlý přístup k nejčastějším akcím
    \item Formulářové prvky pro zadávání a úpravu dat
    \item Responzivní design pro použití na různých zařízeních
\end{itemize}

\newpage

\begin{figure}[ht]  
    \centering
    \includegraphics[width=1\textwidth]{formular01.png}
    \caption{Navrhnutý formulář}
    \label{fig:obrazek01}
\end{figure}

Tento formulář představuje komplexní řešení pro každodenní správu hotelových rezervací s důrazem na efektivitu práce, přehlednost a intuitivní ovládání. Implementované funkce pokrývají celý životní cyklus rezervace od vytvoření přes správu až po platbu a využívání doplňkových služeb.

\newpage
\section{Minispecifikace}

\subsection{Funkce: Vytvoření rezervace}

\subsubsection{Popis}
Tato funkce umožňuje vytvoření nové rezervace v hotelovém systému. Zahrnuje ověření dostupnosti pokoje v požadovaném termínu, případné vytvoření nového hosta, zapsání rezervace, přiřazení zaměstnance, založení platby a aktualizaci stavu pokoje.

\subsubsection{Kroky}
\begin{enumerate}
    \item \textbf{Kontrola dostupnosti pokoje}
    \begin{itemize}
        \item Uživatel zadá požadovaný typ pokoje a termín pobytu (datum příjezdu a odjezdu)
        \item Systém ověří, zda existují volné pokoje daného typu v požadovaném termínu pomocí dotazu na tabulky Room a Reservation
        \item Pokud je pokoj dostupný, systém nabídne konkrétní dostupné pokoje
        \item Pokud není dostupný žádný pokoj daného typu, systém zobrazí upozornění a nabídne alternativní termíny nebo typy pokojů
    \end{itemize}
    
    \item \textbf{Identifikace hosta}
    \begin{itemize}
        \item Uživatel vyhledá hosta v systému podle jména, příjmení nebo e-mailu
        \item Pokud host existuje, jsou jeho údaje načteny do formuláře
        \item Pokud host neexistuje, uživatel zadá nové údaje hosta (jméno, příjmení, e-mail, telefon, datum narození)
        \item V případě nového hosta se také zadá adresa (ulice, město, PSČ, země)
    \end{itemize}
    
    \item \textbf{Výběr zaměstnance}
    \begin{itemize}
        \item Systém automaticky předvyplní aktuálně přihlášeného zaměstnance
        \item Uživatel může změnit zaměstnance, který je zodpovědný za rezervaci
    \end{itemize}
    
    \item \textbf{Zadání detailů rezervace}
    \begin{itemize}
        \item Uživatel zadá nebo potvrdí datum příjezdu a odjezdu
        \item Systém zkontroluje, že datum příjezdu je před datem odjezdu
        \item Uživatel zvolí status rezervace (standardně "Confirmed")
    \end{itemize}
    
    \item \textbf{Výpočet předběžné ceny}
    \begin{itemize}
        \item Systém vypočítá délku pobytu v nocích
        \item Z tabulky RoomType získá cenu za noc pro zvolený typ pokoje
        \item Vypočítá celkovou cenu za ubytování (délka pobytu $\times$ cena za noc)
        \item Uživatel může přidat další výdaje (např. polopenze, parkování)
    \end{itemize}
    
    \item \textbf{Vytvoření platby}
    \begin{itemize}
        \item Systém vytvoří nový záznam v tabulce Payment s vypočítanou cenou ubytování
        \item Nastaví příznak is\_paid na hodnotu 0 (nezaplaceno)
    \end{itemize}
    
    \item \textbf{Vytvoření rezervace a aktualizace stavu pokoje}
    \begin{itemize}
        \item Systém vytvoří nový záznam v tabulce Reservation s vazbami na hosta, pokoj, zaměstnance a platbu
        \item Aktualizuje stav pokoje v tabulce Room (is\_occupied = 1)
    \end{itemize}
\end{enumerate}

\subsubsection{Transakční zpracování}
\begin{itemize}
    \item Všechny kroky 6 a 7 (vytvoření platby, rezervace a aktualizace pokoje) probíhají v rámci jedné transakce
    \item V případě jakékoliv chyby během těchto kroků se celá transakce vrátí zpět (ROLLBACK)
    \item Po úspěšném dokončení všech kroků se transakce potvrdí (COMMIT)
\end{itemize}

\subsubsection{Ošetření chybových stavů}
\begin{itemize}
    \item Kontrola platnosti datumů (datum příjezdu musí být před datem odjezdu)
    \item Kontrola dostupnosti pokoje v daném termínu
    \item Kontrola úplnosti zadaných údajů o hostovi
    \item Kontrola platnosti e-mailu a telefonního čísla
    \item Ošetření současného přístupu více uživatelů k danému pokoji (zamykání záznamů)
\end{itemize}

\subsubsection{SQL příklad pro kontrolu dostupnosti pokoje}
\begin{verbatim}
SELECT r.room_id, r.room_number, rt.name, rt.price_per_night
FROM Room r
JOIN RoomType rt ON r.room_type_id = rt.room_type_id
WHERE r.room_type_id = :selected_room_type_id
  AND r.room_id NOT IN (
    SELECT res.room_id 
    FROM Reservation res 
    WHERE res.status != 'Cancelled'
      AND (
        (:check_in_date BETWEEN res.check_in_date AND res.check_out_date)
        OR (:check_out_date BETWEEN res.check_in_date AND res.check_out_date)
        OR (res.check_in_date BETWEEN :check_in_date AND :check_out_date)
      )
  )
ORDER BY r.room_number;
\end{verbatim}

\subsection{Funkce: Zpracování platby}

\subsubsection{Popis}
Tato funkce umožňuje zpracování platby za rezervaci. Zahrnuje výpočet celkové částky (za ubytování a využité služby), zaznamenání platební metody a označení rezervace jako zaplacené.

\subsubsection{Kroky}
\begin{enumerate}
    \item \textbf{Výběr rezervace}
    \begin{itemize}
        \item Uživatel vybere rezervaci, za kterou chce provést platbu
        \item Systém načte detaily rezervace včetně spojené platby
    \end{itemize}
    
    \item \textbf{Výpočet celkové částky}
    \begin{itemize}
        \item Systém sečte cenu za ubytování (total\_accommodation)
        \item Systém vypočítá celkovou cenu za využité služby z tabulky ServiceUsage
        \item Obě hodnoty jsou sečteny do pole total\_expenses
    \end{itemize}
    
    \item \textbf{Výběr platební metody}
    \begin{itemize}
        \item Uživatel zvolí platební metodu (hotovost, karta, bankovní převod)
    \end{itemize}
    
    \item \textbf{Dokončení platby}
    \begin{itemize}
        \item Systém aktualizuje záznam v tabulce Payment
        \item Nastaví is\_paid na hodnotu 1 (zaplaceno)
        \item Zaznamená aktuální datum jako payment\_date
    \end{itemize}
\end{enumerate}

\subsubsection{SQL příklad pro dokončení platby}
\begin{verbatim}
-- Výpočet celkové ceny za služby
SELECT SUM(total_price)
FROM ServiceUsage
WHERE reservation_id = :reservation_id;

-- Aktualizace platby
UPDATE Payment
SET is_paid = 1,
    payment_date = SYSDATE,
    total_expenses = (SELECT SUM(total_price) FROM ServiceUsage 
                     WHERE reservation_id = :reservation_id) + total_accommodation
WHERE payment_id = (SELECT payment_id FROM Reservation WHERE reservation_id = :reservation_id);
\end{verbatim}

\subsection{Funkce: createReservation(int guestId, int roomId, int employeeId, date checkInDate, date checkOutDate)}

\begin{verbatim}
Začátek transakce:
BEGIN TRANSACTION;

// Kontrola dostupnosti pokoje v zadaném termínu
SELECT COUNT(*)
INTO p_room_count
FROM Reservation res
WHERE res.room_id = :roomId
  AND res.status != 'Cancelled'
  AND (
      (:checkInDate BETWEEN res.check_in_date AND res.check_out_date)
      OR (:checkOutDate BETWEEN res.check_in_date AND res.check_out_date)
      OR (res.check_in_date BETWEEN :checkInDate AND :checkOutDate)
  );

// Pokud je pokoj obsazený, funkce skončí chybou
IF p_room_count > 0 THEN
  ROLLBACK;
  RAISE_APPLICATION_ERROR(-20001, 'Pokoj je v daném termínu již obsazený');
END IF;

// Kontrola platnosti datumů
IF :checkInDate >= :checkOutDate THEN
  ROLLBACK;
  RAISE_APPLICATION_ERROR(-20002, 'Datum příjezdu musí být před datem odjezdu');
END IF;

// Ověření existence hosta, pokud neexistuje, je třeba ho nejprve vytvořit
SELECT COUNT(*)
INTO p_guest_count
FROM Guest
WHERE guest_id = :guestId;

IF p_guest_count = 0 THEN
  ROLLBACK;
  RAISE_APPLICATION_ERROR(-20003, 'Host v systému neexistuje');
END IF;

// Získání typu pokoje a ceny za noc
SELECT rt.room_type_id, rt.price_per_night
INTO p_room_type, p_price_per_night
FROM Room r
JOIN RoomType rt ON r.room_type_id = rt.room_type_id
WHERE r.room_id = :roomId;

// Výpočet délky pobytu a celkové ceny
p_nights := :checkOutDate - :checkInDate;
p_total_accommodation := p_nights * p_price_per_night;

// Vytvoření záznamu platby
INSERT INTO Payment (total_accommodation, total_expenses, payment_date, is_paid)
VALUES (p_total_accommodation, p_total_accommodation, NULL, 0)
RETURNING payment_id INTO p_payment_id;

// Vytvoření záznamu rezervace
INSERT INTO Reservation (guest_id, room_id, employee_id, creation_date, 
                      check_in_date, check_out_date, payment_id, status)
VALUES (:guestId, :roomId, :employeeId, SYSDATE, 
        :checkInDate, :checkOutDate, p_payment_id, 'Confirmed');

// Aktualizace stavu pokoje
UPDATE Room
SET is_occupied = 1
WHERE room_id = :roomId;

COMMIT;
\end{verbatim}

\newpage
\subsection{Funkce: processPayment(int reservationId, string paymentMethod)}

\begin{verbatim}
Začátek transakce:
BEGIN TRANSACTION;

// Ověření, že rezervace existuje
SELECT COUNT(*)
INTO p_reservation_count
FROM Reservation
WHERE reservation_id = :reservationId;

IF p_reservation_count = 0 THEN
  ROLLBACK;
  RAISE_APPLICATION_ERROR(-20001, 'Rezervace s tímto ID neexistuje');
END IF;

// Ověření, že rezervace ještě nebyla zaplacena
SELECT p.is_paid, p.payment_id, p.total_accommodation
INTO p_is_paid, p_payment_id, p_total_accommodation
FROM Reservation r
JOIN Payment p ON r.payment_id = p.payment_id
WHERE r.reservation_id = :reservationId;

IF p_is_paid = 1 THEN
  ROLLBACK;
  RAISE_APPLICATION_ERROR(-20002, 'Tato rezervace je již zaplacena');
END IF;

// Výpočet celkové ceny za služby
SELECT NVL(SUM(total_price), 0)
INTO p_service_total
FROM ServiceUsage
WHERE reservation_id = :reservationId;

// Celková částka k platbě
p_total_expenses := p_total_accommodation + p_service_total;

// Zaznamenání platby podle zvoleného platebního způsobu
IF :paymentMethod NOT IN ('cash', 'card', 'bank_transfer') THEN
  ROLLBACK;
  RAISE_APPLICATION_ERROR(-20003, 'Neplatný způsob platby');
END IF;

// Aktualizace platby
UPDATE Payment
SET is_paid = 1,
    payment_date = SYSDATE,
    total_expenses = p_total_expenses,
    payment_method = :paymentMethod
WHERE payment_id = p_payment_id;

// Přidání záznamu o platbě do logu
INSERT INTO PaymentLog (payment_id, payment_date, payment_method, amount, employee_id)
VALUES (p_payment_id, SYSDATE, :paymentMethod, p_total_expenses, 
        (SELECT employee_id FROM Reservation WHERE reservation_id = :reservationId));

COMMIT;
\end{verbatim}

\end{document}

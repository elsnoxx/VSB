\documentclass[10pt,a4paper]{article}
\usepackage[left=20mm,right=30mm,top=30mm,bottom=35mm]{geometry} 

\usepackage[czech]{babel}
\usepackage{xcolor}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage{hyperref}
\usepackage{float}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
    pdftitle={Projekt DS II - Hotel},
    pdfpagemode=FullScreen,
}

\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\rhead{Projekt DS II - Hotel}
\lfoot{Richard Ficek, FIC0024}
\rfoot{\thepage}

\title{Projekt DS II - Hotel}
\author{Richard Ficek, FIC0024}
\date{\today}

\begin{document}
\maketitle

\newpage

\tableofcontents

\newpage

\section{Datová analýza}
\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{schema.png}
    \caption{Konceptuální datový model}
    \label{fig:obrazek}
\end{figure}

\newpage


\section{Lineární zápis}
Legenda: \textbf{Tabulka}, \underline{primární klíč}, \textit{cizí klíč}, atribut

\begin{itemize} 
    \item \textbf{Guest} – Jeden záznam v této tabulce reprezentuje jednotlivého hosta hotelu se základními informacemi jako jméno, příjmení, kontakt, datum narození, adresa (ulice, město, PSČ, země), typ hosta (např. Regular, VIP, Loyalty) a datum registrace.
    \item \textbf{Employee} – Jeden záznam v této tabulce reprezentuje konkrétního zaměstnance hotelu, včetně jeho identifikátoru, jména, příjmení, pozice a adresy (ulice, město, PSČ, země).
    \item \textbf{RoomType} – Jeden záznam v této tabulce reprezentuje typ pokoje (např. jednolůžkový, dvoulůžkový), včetně počtu postelí. Cena za noc je evidována pouze v tabulce \textbf{RoomTypePriceHistory}.
    \item \textbf{Room} – Jeden záznam v této tabulce reprezentuje jednotlivý pokoj v hotelu s konkrétním číslem, typem pokoje, obsazeností a unikátním identifikátorem.
    \item \textbf{Payment} – Jeden záznam v této tabulce reprezentuje platbu provedenou hostem, včetně částky za ubytování, celkových výdajů, data platby a informace, zda byla platba provedena.
    \item \textbf{Reservation} – Jeden záznam v této tabulce reprezentuje rezervaci vytvořenou hostem, včetně identifikátoru hosta, přiděleného pokoje, zodpovědného zaměstnance, datumu vytvoření, datumu příjezdu a odjezdu, platby a stavu rezervace (např. Confirmed, Checked In, Checked Out, Cancelled).
    \item \textbf{Service} – Jeden záznam v této tabulce reprezentuje službu nebo doplňkový produkt nabízený hotelem, včetně názvu a popisu. Cena služby je evidována pouze v tabulce \textbf{ServicePriceHistory}.
    \item \textbf{ServiceUsage} – Jeden záznam v této tabulce reprezentuje využití konkrétní služby hostem během jeho pobytu v rámci určité rezervace, včetně množství a celkové ceny.
    \item \textbf{Feedback} – Jeden záznam v této tabulce reprezentuje hodnocení a komentář od hosta k jeho pobytu v hotelu, včetně číselného hodnocení, textového komentáře a data poskytnutí zpětné vazby.
    \item \textbf{ServicePriceHistory} – Historie cen služeb, každý záznam obsahuje službu, cenu a období platnosti.
    \item \textbf{RoomTypePriceHistory} – Historie cen typů pokojů, každý záznam obsahuje typ pokoje, cenu za noc a období platnosti.
\end{itemize}

\newpage

\begin{table}[H]
\caption{Atributy tabulky Guest}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    guest\_id             & int                & -              & P             & N              & A               & -              & ID hosta           \\ \hline  
    firstname             & varchar            & 100            & -             & N              & -               & -              & Jméno hosta        \\ \hline  
    lastname              & varchar            & 100            & -             & N              & -               & -              & Příjmení hosta     \\ \hline  
    email                 & varchar            & 100            & -             & N              & -               & -              & Email hosta        \\ \hline  
    phone                 & varchar            & 30             & -             & A              & -               & -              & Telefon hosta      \\ \hline  
    birth\_date           & date               & -              & -             & N              & -               & -              & Datum narození     \\ \hline  
    street                & varchar            & 255            & -             & N              & -               & -              & Ulice              \\ \hline  
    city                  & varchar            & 100            & -             & N              & -               & -              & Město              \\ \hline  
    postal\_code          & char               & 10             & -             & N              & -               & -              & PSČ                \\ \hline
    country               & varchar            & 100            & -             & N              & -               & -              & Země               \\ \hline
    guest\_type           & varchar            & 50             & -             & N              & -               & -              & Typ hosta          \\ \hline  
    registration\_date    & date               & -              & -             & A              & -               & -              & Datum registrace    \\ \hline
    notes                 & clob               & -              & -             & A              & -               & -              & Poznámky hosta     \\ 
        \hline
\end{tabular}  
\label{tab:guest}
\end{table}

\begin{table}[H]
\caption{Atributy tabulky Employee}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    employee\_id          & int                & -              & P             & N              & A               & -              & ID zaměstnance     \\ \hline  
    firstname             & varchar            & 100            & -             & N              & -               & -              & Jméno zaměstnance   \\ \hline  
    lastname              & varchar            & 100            & -             & N              & -               & -              & Příjmení zaměstnance\\ \hline  
    position              & varchar            & 50             & -             & N              & -               & -              & Pozice zaměstnance  \\ \hline
    street                & varchar            & 255            & -             & N              & -               & -              & Ulice              \\ \hline  
    city                  & varchar            & 100            & -             & N              & -               & -              & Město              \\ \hline  
    postal\_code          & char               & 10             & -             & N              & -               & -              & PSČ                \\ \hline
    country               & varchar            & 100            & -             & N              & -               & -              & Země               \\ 
        \hline
\end{tabular}  
\label{tab:employee}
\end{table}

\begin{table}[H]
\caption{Atributy tabulky RoomType}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    room\_type\_id       & int                & -              & P             & N              & A               & -              & ID typu pokoje     \\ \hline  
    name                  & varchar            & 100            & -             & N              & -               & -              & Název typu pokoje   \\ \hline  
    bed\_count            & int                & -              & -             & N              & -               & -              & Počet postelí      \\ 
        \hline
\end{tabular}  
\label{tab:roomtype}
\end{table}

\begin{table}[H]
\caption{Atributy tabulky Room}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    room\_id             & int                & -              & P             & N              & A               & -              & ID pokoje          \\ \hline  
    room\_type\_id       & int                & -              & F(RoomType)   & N              & -               & -              & ID typu pokoje     \\ \hline  
    room\_number          & varchar            & 20             & -             & N              & U               & -              & Číslo pokoje       \\ \hline
    is\_occupied          & boolean            & -              & -             & N              & -               & -              & Obsazenost pokoje  \\ 
        \hline
\end{tabular}  
\label{tab:room}
\end{table}

\begin{table}[H]
\caption{Atributy tabulky Payment}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    payment\_id          & int                & -              & P             & N              & A               & -              & ID platby          \\ \hline  
    total\_accommodation   & decimal            & -              & -             & N              & -               & -              & Celkové náklady na ubytování \\ \hline  
    total\_expenses       & decimal            & -              & -             & N              & -               & -              & Celkové výdaje     \\ \hline  
    payment\_date        & date               & -              & -             & A              & -               & -              & Datum platby       \\ \hline
    is\_paid             & boolean            & -              & -             & N              & -               & -              & Stav platby        \\ 
        \hline
\end{tabular}  
\label{tab:payment}
\end{table}

\begin{table}[H]
\caption{Atributy tabulky Reservation}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    reservation\_id      & int                & -              & P             & N              & A               & -              & ID rezervace       \\ \hline  
    guest\_id             & int                & -              & F(Guest)      & N              & -               & -              & ID hosta           \\ \hline  
    room\_id              & int                & -              & F(Room)       & N              & -               & -              & ID pokoje          \\ \hline  
    employee\_id          & int                & -              & F(Employee)   & N              & -               & -              & ID zaměstnance     \\ \hline  
    creation\_date        & date               & -              & -             & N              & -               & -              & Datum vytvoření    \\ \hline  
    check\_in\_date      & date               & -              & -             & N              & -               & -              & Datum příjezdu     \\ \hline  
    check\_out\_date     & date               & -              & -             & N              & -               & -              & Datum odjezdu      \\ \hline  
    payment\_id          & int                & -              & F(Payment)    & N              & -               & -              & ID platby          \\ \hline
    status                & varchar            & 30             & -             & N              & -               & -              & Stav rezervace     \\ 
        \hline
\end{tabular}  
\label{tab:reservation}
\end{table}

\begin{table}[H]
\caption{Atributy tabulky Service}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    service\_id          & int                & -              & P             & N              & A               & -              & ID služby          \\ \hline  
    name                & varchar            & 100            & -             & N              & -               & -              & Název služby       \\ \hline  
    description         & clob               & -              & -             & A              & -               & -              & Popis služby       \\ 
        \hline
\end{tabular}  
\label{tab:service}
\end{table}

\begin{table}[H]
\caption{Atributy tabulky ServiceUsage}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    usage\_id            & int                & -              & P             & N              & A               & -              & ID využití služby  \\ \hline  
    reservation\_id      & int                & -              & F(Reservation) & N              & -               & -              & ID rezervace       \\ \hline  
    service\_id          & int                & -              & F(Service)    & N              & -               & -              & ID služby          \\ \hline  
    quantity             & int                & -              & -             & N              & -               & -              & Množství           \\ \hline
    total\_price         & decimal            & -              & -             & N              & -               & -              & Celková cena       \\ 
        \hline
\end{tabular}  
\label{tab:serviceusage}

\caption{Atributy tabulky Feedback}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}          & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    feedback\_id         & int                & -              & P             & N              & A               & -              & ID zpětné vazby    \\ \hline  
    guest\_id            & int                & -              & F(Guest)      & N              & -               & -              & ID hosta           \\ \hline  
    reservation\_id      & int                & -              & F(Reservation) & N              & -               & -              & ID rezervace       \\ \hline  
    rating               & int                & -              & -             & N              & -               & -              & Hodnocení (1-5)    \\ \hline  
    comment              & clob               & -              & -             & A              & -               & -              & Komentář           \\ \hline  
    feedback\_date       & date               & -              & -             & A              & -               & -              & Datum hodnocení    \\ 
        \hline
\end{tabular}  
\label{tab:feedback}
\end{table}

\begin{table}[H]
\caption{Atributy tabulky ServicePriceHistory}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}   & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    sph\_id          & int                & -              & P             & N             & A              & -           & ID záznamu historie \\ \hline
    service\_id      & int                & -              & F(Service)    & N             & -              & -           & ID služby          \\ \hline
    price            & decimal            & -              & -             & N             & -              & -           & Cena služby        \\ \hline
    valid\_from      & date               & -              & -             & N             & -              & -           & Začátek platnosti  \\ \hline
    valid\_to        & date               & -              & -             & A             & -              & -           & Konec platnosti    \\
    \hline
\end{tabular}
\label{tab:servicepricehistory}
\end{table}

\begin{table}[H]
\caption{Atributy tabulky RoomTypePriceHistory}
\begin{tabular}{|l|l|c|c|c|c|c|l|}
    \hline
    \textbf{Název}        & \textbf{Dat. Typ} & \textbf{Délka} & \textbf{Klíč} & \textbf{Null} & \textbf{Index} & \textbf{IO} & \textbf{Význam} \\ \hline
    rtph\_id              & int                & -              & P             & N             & A              & -           & ID záznamu historie \\ \hline
    room\_type\_id        & int                & -              & F(RoomType)   & N             & -              & -           & ID typu pokoje      \\ \hline
    price\_per\_night     & decimal            & -              & -             & N             & -              & -           & Cena za noc         \\ \hline
    valid\_from           & date               & -              & -             & N             & -              & -           & Začátek platnosti   \\ \hline
    valid\_to             & date               & -              & -             & A             & -              & -           & Konec platnosti     \\
    \hline
\end{tabular}
\label{tab:roomtypepricehistory}
\end{table}


\section{Integritní omezení}

\begin{itemize}
    \item \textbf{check\_in\_date} $<$ \textbf{check\_out\_date} – Datum příjezdu musí být dříve než datum odjezdu.
    \item \textbf{guest\_type} – Může nabývat hodnot \{Regular, VIP, Loyalty\}.
    \item \textbf{status} – Může nabývat hodnot \{Confirmed, Checked In, Checked Out, Cancelled\}.
    \item \textbf{room\_type\_id} – Odkazuje na existující záznam v tabulce \textbf{RoomType}.
    \item \textbf{payment\_id} – Odkazuje na existující záznam v tabulce \textbf{Payment}.
    \item \textbf{is\_paid} – Může nabývat hodnot \{0 (neuhrazeno), 1 (uhrazeno)\}.
    \item \textbf{room\_number} – Musí být unikátní v rámci tabulky \textbf{Room}.
    \item \textbf{rating} – Může nabývat hodnot od 1 do 5, představujících hodnocení spokojenosti hosta.
    \item \textbf{quantity} – Musí být větší než 0, určuje počet využitých jednotek služby.
    \item \textbf{service\_id} – Odkazuje na existující záznam v tabulce \textbf{Service}.
    \item \textbf{reservation\_id} v \textbf{ServiceUsage} a \textbf{Feedback} – Odkazuje na existující záznam v tabulce \textbf{Reservation}.
    \item \textbf{price} v \textbf{Service} – Musí být nezáporná hodnota.
    \item \textbf{total\_price} v \textbf{ServiceUsage} – Musí být nezáporná hodnota.
    \item \textbf{email} – Musí obsahovat znak @ a platnou doménu.
    \item \textbf{total\_accommodation} a \textbf{total\_expenses} – Musí být nezáporné hodnoty.
    \item \textbf{service\_id} v \textbf{ServicePriceHistory} – Odkazuje na existující záznam v tabulce \textbf{Service}.
    \item \textbf{room\_type\_id} v \textbf{RoomTypePriceHistory} – Odkazuje na existující záznam v tabulce \textbf{RoomType}.
    \item \textbf{price} v \textbf{ServicePriceHistory} – Musí být nezáporná hodnota.
    \item \textbf{price\_per\_night} v \textbf{RoomTypePriceHistory} – Musí být nezáporná hodnota.
    \item \textbf{valid\_from} $<$ \textbf{valid\_to} – Začátek platnosti musí být dříve než konec platnosti (pokud je konec vyplněn).
\end{itemize}

\newpage
\section{Návrh formuláře}

\subsection{Popis formuláře}
Formulář Správa hotelových rezervací je centrálním bodem pro práci s rezervacemi v hotelovém systému. Umožňuje vyhledávání, zobrazení detailů a správu rezervací včetně přidružených entit. Formulář pracuje s následujícími tabulkami:

\begin{figure}[ht]  
    \centering
    \includegraphics[width=0.9\textwidth]{formular01.png}
    \caption{Navrhnutý formulář}
    \label{fig:obrazek01}
\end{figure}

\newpage

\subsection{Popis formuláře}

% \subsubsection{Proměnné formuláře:}

% \begin{itemize}
%     \item \textbf{vf\_id\_reservation}: ID aktuální rezervace, inicializováno na null.
%     \item \textbf{vf\_id\_guest}: ID aktuálního hosta, inicializováno na null.
%     \item \textbf{vf\_id\_room}: ID vybraného pokoje, inicializováno na null.
%     \item \textbf{vf\_id\_payment}: ID platby k rezervaci, inicializováno na null.
%     \item \textbf{vf\_check\_in\_date}: Datum příjezdu, vstupní parametr.
%     \item \textbf{vf\_check\_out\_date}: Datum odjezdu, vstupní parametr.
%     \item \textbf{vf\_status}: Stav rezervace (Confirmed, Checked-In, Checked-Out, Cancelled).
%     \item \textbf{vf\_guest\_type}: Typ hosta (Regular, VIP, Loyalty).
%     \item \textbf{vf\_room\_type}: Typ pokoje (např. jednolůžkový, dvoulůžkový).
%     \item \textbf{vf\_total\_accommodation}: Cena za ubytování, vypočtená hodnota.
%     \item \textbf{vf\_total\_services}: Cena za služby, vypočtená hodnota.
%     \item \textbf{vf\_is\_paid}: Stav platby (0/1), aktualizováno po zaplacení.
%     \item \textbf{vf\_service\_list}: Seznam služeb přidaných k rezervaci.
%     \item \textbf{vf\_selected\_service}: ID vybrané služby pro přidání.
%     \item \textbf{vf\_service\_quantity}: Počet jednotek vybrané služby.
% \end{itemize}

\subsubsection{Návrh formuláře:}

\begin{itemize}
    \item \textbf{Vyhledání rezervace:} Zadáním data příjezdu a stiskem tlačítka „Vyhledat“ se spustí funkce \textbf{getReservationByCheckin}, která zobrazí odpovídající rezervace.

    \item \textbf{Vytvoření nové rezervace:} Stiskem tlačítka „Nová rezervace“ se otevře formulář pro zadání údajů o hostovi, pokoji, termínu a dalších potřebných informací. Po potvrzení se spustí funkce \textbf{createReservation}, která provede všechny potřebné kontroly a vytvoří novou rezervaci v systému.

    \item \textbf{Výběr rezervace:} Kliknutím na řádek v tabulce rezervací se načtou detailní informace pomocí funkce \textbf{getReservationDetail}.

    \item \textbf{Změna stavu rezervace:} Změnou hodnoty v poli „State“ se volá funkce \textbf{changeStatusReservation}.

    \item \textbf{Změna pokoje:} Výběrem jiného pokoje v poli „Room no“. Po stisku tlačítka „Change“ se použije funkce \textbf{changeRoom}, která ověří dostupnost pokoje a přepočítá cenu.

    \item \textbf{Zaplacení rezervace:} Stiskem tlačítka „Pay“ se provede funkce \textbf{payForReservation}, která označí rezervaci jako zaplacenou.

    \item \textbf{Přidání služby:} Výběrem služby a zadáním množství, následně stiskem tlačítka „Add“, se použije funkce \textbf{addService}.

    \item \textbf{Odebrání služby:} Stiskem tlačítka „Del“ u konkrétní služby se použije funkce \textbf{deleteService}.

    \item \textbf{Zobrazení cen a služeb:} Pro výpočet a zobrazení cen za ubytování a služby jsou využity funkce \textbf{getPriceOfAccommodation}, \textbf{getUsageService} a \textbf{getPriceOfService}.

\end{itemize}

\newpage

\subsection{Seznam funkcí}
Formulář Správa hotelových rezervací poskytuje následujících 10 funkcí, které jsou rozděleny na dvě kategorie podle způsobu volání:

\subsubsection{Funkce typu Result (výsledkové)}

\begin{enumerate}
    \item getGuestInformation(reservation\_id) – Načte informace o hostovi podle zadané rezervace (jméno, příjmení, email, telefon, adresa).
    \item getReservationList() – Vrátí seznam všech rezervací včetně jména hosta, čísla pokoje, data příjezdu a stavu rezervace.
    \item getPriceOfAccommodation(reservation\_id) – Vrátí cenu za ubytování uloženou v rezervaci (hodnota \texttt{accommodation\_price} v tabulce Reservation pro dané \texttt{reservation\_id}).
    \item getUsedServices(reservation\_id) – Vrátí seznam služeb využitých v rámci rezervace včetně množství a ceny.
    \item getPriceOfServices(reservation\_id) – Spočítá a zobrazí celkovou cenu za všechny služby v rámci rezervace.
    \item getFreeRoomList(check\_in\_date, check\_out\_date) – Vrátí seznam volných pokojů pro zadaný termín.
    \item getServiceList() – Vrátí seznam všech dostupných služeb.
    \item getReservationState() – Vrátí seznam možných stavů rezervace.
\end{enumerate}

\subsubsection{Funkce typu Invocation (vyvolávací)}

\begin{enumerate}\setcounter{enumi}{8}
    \item getReservationByCheckin(check\_in\_date) – Filtrování rezervací podle data příjezdu.
    \item changeStatusReservation(reservation\_id, new\_status) – Změní stav rezervace na zvolenou hodnotu.
    \item changeRoom(reservation\_id, new\_room\_id) – Změní přiřazený pokoj v rezervaci, ověří dostupnost a přepočítá cenu.
    \item payForReservation(payment\_id) – Označí rezervaci jako zaplacenou a nastaví datum platby.
    \item addService(reservation\_id, service\_id, quantity, usage\_date) – Přidá službu k rezervaci, vypočítá cenu a uloží záznam.
    \item deleteService(usage\_id) – Odstraní službu z rezervace a aktualizuje celkovou cenu.
\end{enumerate}

% \subsection{Detailní popis funkcí}

% \subsubsection{getPriceOfAccommodation}
% \textbf{Vstupy:} \\
% p\_reservation\_id

% \textbf{Postup:}
% \begin{enumerate}
%     \item Zjisti typ pokoje a termín rezervace podle \texttt{Reservation} (dle \texttt{reservation\_id}).
%     \item Zjisti cenu za noc z tabulky \texttt{RoomTypePriceHistory} podle typu pokoje a data příjezdu (\texttt{check\_in\_date} spadá do platnosti ceny).
%     \item Spočítej počet nocí jako rozdíl \texttt{check\_out\_date} a \texttt{check\_in\_date}.
%     \item Výsledná cena = počet nocí $\times$ cena za noc.
% \end{enumerate}

% \subsubsection{getPriceOfService}
% \textbf{Vstupy:} \\
% p\_service\_id, p\_quantity, p\_usage\_date

% \textbf{Postup:}
% \begin{enumerate}
%     \item Zjisti jednotkovou cenu služby z tabulky \texttt{ServicePriceHistory} podle zadaného \texttt{service\_id} a data využití služby (\texttt{usage\_date} spadá do platnosti ceny).
%     \item Vypočítej celkovou cenu služby jako jednotková cena vynásobená množstvím.
% \end{enumerate}


% \subsubsection{addService}
% \textbf{Vstupy:} \\
% p\_reservation\_id, p\_service\_id, p\_quantity, p\_usage\_date

% \textbf{Postup:}
% \begin{enumerate}
%     \item Zjisti jednotkovou cenu služby z tabulky \texttt{ServicePriceHistory} podle \texttt{service\_id} a data využití.
%     \item Vypočítej celkovou cenu služby (jednotková cena krát množství).
%     \item Vlož nový záznam o využití služby do tabulky \texttt{ServiceUsage} s příslušnými hodnotami.
% \end{enumerate}


% \subsubsection{payForReservation}
% \textbf{Vstupy:} \\
% p\_payment\_id

% \textbf{Postup:}
% \begin{enumerate}
%     \item Najdi platbu podle \texttt{payment\_id}.
%     \item Označ platbu jako zaplacenou a nastav datum platby na aktuální datum.
% \end{enumerate}


% \subsubsection{getReservationDetail}
% \textbf{Vstupy:} \\
% p\_reservation\_id

% \textbf{Postup:}
% \begin{enumerate}
%     \item Načti základní údaje o rezervaci podle \texttt{reservation\_id}.
%     \item Získej informace o hostovi, pokoji, platbě a využitých službách spojených s touto rezervací.
%     \item Zobraz detailní informace uživateli.
% \end{enumerate}



\newpage
\section{Minispecifikace}

% \subsection{Transakce: Vytvoření rezervace}

% \subsubsection{Popis transakce}
% Transakce zajistí vytvoření nové rezervace v hotelovém systému. Ověří dostupnost pokoje, případně založí nového hosta, vytvoří rezervaci, založí platbu a nastaví pokoj jako obsazený. Vše probíhá atomicky – v případě chyby se provede rollback.

% \subsubsection{Kroky transakce}
% \begin{enumerate}
%     \item \textbf{Start transakce}
%     \item \textbf{Ověření dostupnosti pokoje:}
%     \begin{itemize}
%         \item Zjisti, zda je pokoj v požadovaném termínu volný:
% \begin{verbatim}
% SELECT COUNT(*)
% FROM Reservation res
% WHERE res.room_id = :roomId
%   AND res.status != 'Cancelled'
%   AND (
%       (:checkInDate BETWEEN res.check_in_date AND res.check_out_date)
%       OR (:checkOutDate BETWEEN res.check_in_date AND res.check_out_date)
%       OR (res.check_in_date BETWEEN :checkInDate AND :checkOutDate)
%   );
% \end{verbatim}
%         \item Pokud není volný, proveď rollback a ukonči transakci.
%     \end{itemize}
%     \item \textbf{Ověření platnosti dat:}
%     \begin{itemize}
%         \item Zkontroluj, že datum příjezdu je před datem odjezdu.
%         \item Pokud ne, rollback a ukončení transakce.
%     \end{itemize}
%     \item \textbf{Ověření existence hosta:}
%     \begin{itemize}
%         \item Pokud host neexistuje, založ nového hosta a adresu.
%         \item Pokud host existuje, pokračuj.
%     \end{itemize}
%     \item \textbf{Získání ceny za noc a výpočet ceny:}
%     \begin{itemize}
%         \item Zjisti typ pokoje a cenu za noc:
% \begin{verbatim}
% SELECT rh.price_per_night
% FROM Room r
% JOIN RoomType rt ON r.room_type_id = rt.room_type_id
% JOIN RoomTypePriceHistory rh ON rh.room_type_id = rt.room_type_id
%   AND :checkInDate BETWEEN rh.valid_from AND NVL(rh.valid_to, :checkInDate)
% WHERE r.room_id = :roomId;
% \end{verbatim}
%         \item Spočítej počet nocí a celkovou cenu.
%     \end{itemize}
%     \item \textbf{Vložení platby:}
%     \begin{itemize}
%         \item Vlož záznam do tabulky Payment s vypočtenou cenou, is\_paid = 0.
%         \item Získej payment\_id.
%     \end{itemize}
%     \item \textbf{Vložení rezervace:}
%     \begin{itemize}
%         \item Vlož záznam do tabulky Reservation s vazbou na hosta, pokoj, zaměstnance a platbu.
%     \end{itemize}
%     \item \textbf{Nastavení pokoje jako obsazeného:}
%     \begin{itemize}
%         \item Aktualizuj stav pokoje:
% \begin{verbatim}
% UPDATE Room SET is_occupied = 1 WHERE room_id = :roomId;
% \end{verbatim}
%     \end{itemize}
%     \item \textbf{Commit transakce}
%     \item \textbf{V případě chyby rollback a ukončení transakce}
% \end{enumerate}

\subsection{changeRoom}

\subsubsection{Transakce: Popis transakce}
Transakce zajišťuje změnu přiřazeného pokoje pro existující rezervaci. Ověří dostupnost nového pokoje v požadovaném termínu, aktualizuje rezervaci a provede změnu atomicky. V případě chyby dojde k rollbacku.

\subsubsection{Kroky transakce}
\begin{enumerate}
    \item \textbf{Start transakce}
    
    \item \textbf{Načtení dat rezervace}
    \begin{itemize}
        \item Získej \texttt{check\_in\_date}, \texttt{check\_out\_date}, \texttt{room\_id}, \texttt{accommodation\_price} z tabulky \texttt{Reservation} podle \texttt{reservation\_id}.
    \end{itemize}
    
    \item \textbf{Ověření dostupnosti nového pokoje}
    \begin{itemize}
        \item Zkontroluj, zda je nový pokoj v požadovaném termínu volný:
\begin{verbatim}
SELECT COUNT(*)
FROM Reservation res
WHERE res.room_id = :newRoomId
  AND res.status != 'Cancelled'
  AND (
      (:checkInDate BETWEEN res.check_in_date AND res.check_out_date)
      OR (:checkOutDate BETWEEN res.check_in_date AND res.check_out_date)
      OR (res.check_in_date BETWEEN :checkInDate AND :checkOutDate)
  );
\end{verbatim}
        \item Pokud je výsledek větší než 0, proveď rollback a ukonči transakci.
    \end{itemize}

    \item \textbf{Aktualizace rezervace}
    \begin{itemize}
        \item Spočítej novou cenu pomocí funkce \texttt{getPriceOfAccommodation}.
        \item Proveď aktualizaci záznamu:
\begin{verbatim}
UPDATE Reservation
SET room_id = :newRoomId,
    accommodation_price = :newAccommodationPrice
WHERE reservation_id = :reservationId;
\end{verbatim}
    \end{itemize}

    \item \textbf{Commit transakce}

    \item \textbf{V případě chyby rollback a ukončení transakce}
\end{enumerate}


\end{document}
